#!/bin/sh


if [ "$help" = "1" ]
then
	cat << EOF
FFMPEG/avformat options:

  --avformat-cvs          - Obtain ffmpeg from CVS
  --avformat-shared=path  - Link against a shared installation of ffmpeg (default)
  --avformat-static=path  - Link against a static ffmpeg dev tree
  --avformat-ldextra=libs - Provide additional libs to link with

EOF

else
        targetos=$(uname -s)
	case $targetos in
	Darwin)
		export LIBSUF=.dylib
		;;
	Linux)
		export LIBSUF=.so
		;;
	*)
		;;
	esac
		
	echo > config.mak

	export static_ffmpeg=
	export shared_ffmpeg=`whereis ffmpeg | cut -f 2 -d' '`
	export extra_libs=
	export cvs_ffmpeg=

	if [ "$shared_ffmpeg" != "" ]
	then
		# Chop ffmpeg 
		shared_ffmpeg=`dirname $shared_ffmpeg`
		# Chop bin 
		shared_ffmpeg=`dirname $shared_ffmpeg`
	fi

	for i in "$@"
	do
		case $i in
			--avformat-static=* )	static_ffmpeg="${i#--avformat-static=}" ;;
			--avformat-shared=* )	shared_ffmpeg="${i#--avformat-shared=}" ;;
			--avformat-ldextra=* )	extra_libs="${i#--avformat-ldextra=}" ;;
			--avformat-cvs )		cvs_ffmpeg=true ;;
		esac
	done

	if [ "$cvs_ffmpeg" != "" ]
	then
		[ ! -d "ffmpeg" ] && cvs -z9 -d:pserver:anonymous@mplayerhq.hu:/cvsroot/ffmpeg co ffmpeg
		[ -d "ffmpeg" ] && ( cd ffmpeg ; ./configure --enable-shared )
		#[ ! -f "ffmpeg/ffmpeg.patch" ] && ( cd ffmpeg ; cp ../ffmpeg.patch . ; patch -p0 < ffmpeg.patch )
		echo "CFLAGS+=-I`pwd`/ffmpeg/libavformat -I`pwd`/ffmpeg/libavcodec" >> config.mak
		echo "LOCAL_FFMPEG=1" >> config.mak
		extra_libs="$extra_libs -lz"
	elif [ "$static_ffmpeg" != "" ]
	then 
		if [ -d "$static_ffmpeg" ]
		then
			echo "CFLAGS+=-I$static_ffmpeg/libavformat -I$static_ffmpeg/libavcodec" >> config.mak
			echo "LDFLAGS+=-L$static_ffmpeg/libavformat -L$static_ffmpeg/libavcodec" >> config.mak
			[ $targetos = "Darwin" ] &&
			 	echo "LDFLAGS+=-single_module" >> config.mak
		else
			echo "avformat: Invalid path specified: $static_ffmpeg"
			touch ../disable-avformat
			echo 0
		fi
	else 
		if [ -d "$shared_ffmpeg/include/ffmpeg" -a -f "$shared_ffmpeg/lib/libavformat.so" ]
		then
			echo "CFLAGS+=-I$shared_ffmpeg/include/ffmpeg " >> config.mak
			echo "LDFLAGS+=-L$shared_ffmpeg/lib" >> config.mak
		else
			echo "avformat: No build environment found. "
			echo "          Try configuring mlt with --avformat-cvs."
			touch ../disable-avformat
			exit 0
		fi
	fi

	echo "EXTRA_LIBS=$extra_libs" >> config.mak

cat << EOF >> ../producers.dat
avformat		libmltavformat$LIBSUF
EOF

cat << EOF >> ../filters.dat
avdeinterlace	libmltavformat$LIBSUF
avresample		libmltavformat$LIBSUF
avcolour_space	libmltavformat$LIBSUF
EOF

cat << EOF >> ../consumers.dat
avformat		libmltavformat$LIBSUF
EOF

fi

